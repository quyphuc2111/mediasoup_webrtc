name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            arch: aarch64
          - platform: macos-latest
            target: x86_64-apple-darwin
            arch: x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
    
    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install dependencies
        run: npm install
      
      - name: Install mediasoup-server dependencies
        run: cd mediasoup-server && npm install
      
      - name: Build mediasoup-server
        run: cd mediasoup-server && npm run build
      
      - name: Prepare binaries
        run: npm run prepare:binaries
      
      - name: Build frontend
        run: npm run build
      
      - name: Build Tauri app (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: "Zenadev@123@"
        run: npm run tauri build -- --target ${{ matrix.target }} --bundles app
      
      - name: Build Tauri app (Windows)
        if: matrix.platform == 'windows-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: "Zenadev@123@"
        run: npm run tauri build -- --target ${{ matrix.target }} --bundles nsis
      
      - name: Debug - List Windows build output
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "=== Checking build output ==="
          $BundlePath = "src-tauri/target/${{ matrix.target }}/release/bundle/nsis"
          
          if (Test-Path $BundlePath) {
            Write-Host "‚úÖ Bundle path exists: $BundlePath"
            Write-Host "=== Files in bundle directory ==="
            Get-ChildItem -Path $BundlePath | ForEach-Object {
              Write-Host "  - $($_.Name) ($($_.Length) bytes)"
            }
          } else {
            Write-Host "‚ùå Bundle path not found: $BundlePath"
          }
          
          Write-Host "`n=== All bundle directories ==="
          if (Test-Path "src-tauri/target/${{ matrix.target }}/release/bundle") {
            Get-ChildItem -Path "src-tauri/target/${{ matrix.target }}/release/bundle" -Recurse -File | Select-Object FullName, Length
          }
      
      - name: Rename artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cd src-tauri/target/${{ matrix.target }}/release/bundle/macos
          
          # Find the tar.gz file
          TAR_FILE=$(ls *.app.tar.gz | head -n 1)
          SIG_FILE=$(ls *.app.tar.gz.sig | head -n 1)
          
          # Rename with version and arch
          mv "$TAR_FILE" "SmartlabPromax_${VERSION}_${{ matrix.arch }}.app.tar.gz"
          mv "$SIG_FILE" "SmartlabPromax_${VERSION}_${{ matrix.arch }}.app.tar.gz.sig"
      
      - name: Rename artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
          
          # Windows build uses target-specific path
          $BundlePath = "src-tauri/target/${{ matrix.target }}/release/bundle/nsis"
          
          if (Test-Path $BundlePath) {
            cd $BundlePath
            
            # Find the exe file (already has version in name)
            $ExeFile = Get-ChildItem *.exe -Exclude *.sig | Select-Object -First 1
            $SigFile = Get-ChildItem *.exe.sig | Select-Object -First 1
            
            if ($ExeFile -and $SigFile) {
              Write-Host "‚úÖ Found Windows artifacts:"
              Write-Host "  - $($ExeFile.Name)"
              Write-Host "  - $($SigFile.Name)"
              
              # Files already have correct naming from Tauri
              # Just verify they exist
            } else {
              Write-Host "‚ö†Ô∏è No exe or sig files found"
              exit 1
            }
          } else {
            Write-Host "‚ùå Bundle path not found: $BundlePath"
            exit 1
          }
      
      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.sig
      
      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-artifacts
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.sig
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Install dependencies
        run: npm install
      
      - name: Organize artifacts
        run: |
          mkdir -p src-tauri/target/release/bundle/macos
          mkdir -p src-tauri/target/release/bundle/nsis
          
          # Copy macOS artifacts
          if [ -d "artifacts/macos-aarch64-artifacts" ]; then
            cp artifacts/macos-aarch64-artifacts/*.tar.gz src-tauri/target/release/bundle/macos/ || true
            cp artifacts/macos-aarch64-artifacts/*.sig src-tauri/target/release/bundle/macos/ || true
          fi
          
          if [ -d "artifacts/macos-x64-artifacts" ]; then
            cp artifacts/macos-x64-artifacts/*.tar.gz src-tauri/target/release/bundle/macos/ || true
            cp artifacts/macos-x64-artifacts/*.sig src-tauri/target/release/bundle/macos/ || true
          fi
          
          # Copy Windows artifacts
          if [ -d "artifacts/windows-x64-artifacts" ]; then
            cp artifacts/windows-x64-artifacts/*.exe src-tauri/target/release/bundle/nsis/ || true
            cp artifacts/windows-x64-artifacts/*.sig src-tauri/target/release/bundle/nsis/ || true
          fi
      
      - name: Generate manifest
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          REPO=${{ github.repository }}
          node scripts/generate-github-manifest.cjs "$VERSION" "$REPO" "Release v$VERSION"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.exe
            artifacts/**/*.sig
            latest.json
          body: |
            ## üéâ SmartLab ProMax ${{ github.ref_name }}
            
            ### üì¶ Downloads
            
            **macOS:**
            - Apple Silicon (M1/M2/M3): `SmartlabPromax_*_aarch64.app.tar.gz`
            - Intel: `SmartlabPromax_*_x64.app.tar.gz`
            
            **Windows:**
            - `SmartlabPromax_*_x64-setup.exe`
            
            ### üîÑ Auto Update
            If you already have the app installed, it will automatically check for this update.
            
            ### üìù Installation
            
            **macOS:**
            1. Download the appropriate `.tar.gz` file for your Mac
            2. Extract: `tar -xzf SmartlabPromax_*.app.tar.gz`
            3. Move `SmartlabPromax.app` to Applications folder
            4. First time: Right-click ‚Üí Open (to bypass Gatekeeper)
            
            **Windows:**
            1. Download the `.exe` installer
            2. Run the installer
            3. Follow the installation wizard
            
            ### üîê Verification
            All packages are signed and verified automatically by the updater.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
