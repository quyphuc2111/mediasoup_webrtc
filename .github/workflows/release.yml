name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build SmartlabPromax
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        shell: pwsh
        run: |
          # Check if Node.js is installed
          $nodeVersion = node --version 2>$null
          if ($nodeVersion) {
            Write-Host "Node.js already installed: $nodeVersion"
          } else {
            Write-Host "Node.js not found, please install Node.js 20+ on the runner"
            exit 1
          }

      - name: Setup Rust
        shell: pwsh
        run: |
          # Check if Rust is installed
          $rustVersion = rustc --version 2>$null
          if ($rustVersion) {
            Write-Host "Rust already installed: $rustVersion"
          } else {
            Write-Host "Rust not found, please install Rust on the runner"
            exit 1
          }
          
          # Add Windows MSVC target if not present
          rustup target add x86_64-pc-windows-msvc 2>$null
          
          # Show installed targets
          rustup target list --installed

      - name: Install frontend dependencies
        shell: pwsh
        run: npm ci

      - name: Build Tauri App
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run tauri build -- --target x86_64-pc-windows-msvc --bundles nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SmartlabPromax-windows
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: 'SmartlabPromax ${{ github.ref_name }}'
          body: |
            ## SmartlabPromax - Pháº§n má»m quáº£n lÃ½ phÃ²ng mÃ¡y
            
            ### TÃ­nh nÄƒng:
            - ğŸ–¥ï¸ Chia sáº» mÃ n hÃ¬nh giÃ¡o viÃªn
            - ğŸ‘ï¸ Xem mÃ n hÃ¬nh há»c sinh
            - ğŸ–±ï¸ Äiá»u khiá»ƒn tá»« xa
            - ğŸ“¤ Gá»­i/nháº­n file (chunked TCP)
            - ğŸ“‚ File Manager 2 panel
            - ğŸ” XÃ¡c thá»±c Ed25519 & LDAP
            - ğŸŒ Tá»± Ä‘á»™ng phÃ¡t hiá»‡n LAN
            
            ### CÃ i Ä‘áº·t:
            Táº£i file `.exe` vÃ  cháº¡y Ä‘á»ƒ cÃ i Ä‘áº·t.
          files: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
