name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build SmartlabPromax
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install frontend dependencies
        run: npm ci

      # Temporarily disabled - mediasoup server build
      # - name: Install mediasoup-server dependencies
      #   run: npm ci
      #   working-directory: mediasoup-server

      # - name: Build mediasoup-server
      #   run: npm run build
      #   working-directory: mediasoup-server

      # - name: Download Node.js portable
      #   shell: bash
      #   run: |
      #     # Retry logic for download
      #     MAX_RETRIES=3
      #     RETRY_COUNT=0
      #     while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
      #       echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES to download Node.js..."
      #       if curl -L --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 -o node.zip https://nodejs.org/dist/v20.18.0/node-v20.18.0-win-x64.zip; then
      #         echo "Download successful!"
      #         break
      #       else
      #         RETRY_COUNT=$((RETRY_COUNT + 1))
      #         if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
      #           echo "Download failed, retrying in 10 seconds..."
      #           sleep 10
      #         else
      #           echo "Download failed after $MAX_RETRIES attempts"
      #           exit 1
      #         fi
      #       fi
      #     done
      #     
      #     # Verify download
      #     if [ ! -f node.zip ] || [ ! -s node.zip ]; then
      #       echo "Error: node.zip is missing or empty"
      #       exit 1
      #     fi
      #     
      #     echo "Extracting Node.js..."
      #     unzip -q node.zip
      #     mkdir -p src-tauri/binaries/node
      #     mv node-v20.18.0-win-x64/* src-tauri/binaries/node/
      #     echo "Node.js extracted successfully"

      # - name: Prepare sidecar
      #   shell: bash
      #   run: |
      #     mkdir -p src-tauri/binaries/server
      #     cp -r mediasoup-server/dist src-tauri/binaries/server/
      #     cp -r mediasoup-server/node_modules src-tauri/binaries/server/
      #     cp mediasoup-server/package.json src-tauri/binaries/server/

      - name: Build SmartlabPromax
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'SmartlabPromax ${{ github.ref_name }}'
          releaseBody: |
            ## SmartlabPromax - Ph·∫ßn m·ªÅm qu·∫£n l√Ω ph√≤ng m√°y
            
            ### T√≠nh nƒÉng:
            - üñ•Ô∏è Chia s·∫ª m√†n h√¨nh gi√°o vi√™n
            - üëÅÔ∏è Xem m√†n h√¨nh h·ªçc sinh
            - üñ±Ô∏è ƒêi·ªÅu khi·ªÉn t·ª´ xa
            - üì§ G·ª≠i/nh·∫≠n file
            - üîê X√°c th·ª±c Ed25519 & LDAP
            - üåê T·ª± ƒë·ªông ph√°t hi·ªán LAN
            
            ### C√†i ƒë·∫∑t:
            T·∫£i file `.exe` v√† ch·∫°y ƒë·ªÉ c√†i ƒë·∫∑t.
          releaseDraft: false
          prerelease: false
          args: --target x86_64-pc-windows-msvc --bundles nsis
