name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'v0.0.0-dev'

permissions:
  contents: write

jobs:
  # ============================================================
  # Windows Builds
  # ============================================================
  build-windows-teacher:
    name: Build Windows Teacher
    runs-on: windows-latest
    env:
      # Use short path to avoid Windows path length issues with mediasoup-sys
      CARGO_TARGET_DIR: C:\t
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies for mediasoup
        shell: pwsh
        run: |
          python -m pip install invoke meson ninja
          # Verify executables are in PATH
          meson --version
          ninja --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            ./src-tauri -> target
          cache-targets: false

      - name: Install frontend dependencies
        run: npm ci

      - name: Disable Windows Defender for build folder
        shell: pwsh
        run: |
          # Disable real-time scanning for build paths to avoid ninja race condition
          Add-MpPreference -ExclusionPath "C:\t"
          Add-MpPreference -ExclusionPath "${{ github.workspace }}"

      - name: Build mediasoup-rust-server
        shell: pwsh
        env:
          PYTHONPATH: ${{ env.pythonLocation }}\Lib\site-packages
        run: |
          $env:PATH = "${{ env.pythonLocation }}\Scripts;$env:PATH"
          cargo build --release
        working-directory: mediasoup-rust-server

      - name: Prepare mediasoup-rust-server binary
        shell: bash
        run: |
          mkdir -p src-tauri/binaries/server
          cp C:/t/release/mediasoup-rust-server.exe src-tauri/binaries/server/

      - name: Build frontend
        run: npm run build

      - name: Build Tauri Teacher App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_TARGET_DIR: target
        with:
          tagName: ${{ github.ref_name || github.event.inputs.version }}
          releaseName: 'SmartlabPromax ${{ github.ref_name || github.event.inputs.version }}'
          releaseBody: |
            ## SmartlabPromax - Pháº§n má»m quáº£n lÃ½ phÃ²ng mÃ¡y
            
            ### Downloads:
            - **SmartlabPromax** (Teacher): CÃ³ mediasoup server, dÃ¹ng cho giÃ¡o viÃªn
            - **SmartlabStudent** (Student): Lightweight client, dÃ¹ng cho há»c sinh
            
            ### TÃ­nh nÄƒng:
            - ðŸ–¥ï¸ Chia sáº» mÃ n hÃ¬nh (WebRTC/Mediasoup)
            - ðŸ‘ï¸ Xem mÃ n hÃ¬nh há»c sinh real-time
            - ðŸ–±ï¸ Äiá»u khiá»ƒn tá»« xa
            - ðŸ“¤ Gá»­i/nháº­n file qua LAN
            - ðŸ” XÃ¡c thá»±c Ed25519 & LDAP
            - ðŸŒ Tá»± Ä‘á»™ng phÃ¡t hiá»‡n thiáº¿t bá»‹ LAN
            
            ### YÃªu cáº§u há»‡ thá»‘ng:
            - Windows 10/11 (64-bit), macOS 10.13+, Linux
            - RAM: 4GB+
          releaseDraft: false
          prerelease: false
          args: --target x86_64-pc-windows-msvc --bundles nsis

  build-windows-student:
    name: Build Windows Student
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri Student App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name || github.event.inputs.version }}
          releaseName: 'SmartlabPromax ${{ github.ref_name || github.event.inputs.version }}'
          releaseDraft: false
          prerelease: false
          args: --config src-tauri/tauri.student.conf.json --target x86_64-pc-windows-msvc --bundles nsis

  # ============================================================
  # macOS Builds
  # ============================================================
  build-macos-teacher:
    name: Build macOS Teacher
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies for mediasoup
        run: |
          python -m pip install --upgrade pip
          pip install invoke meson ninja

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            ./src-tauri -> target
            ./mediasoup-rust-server -> target

      - name: Install frontend dependencies
        run: npm ci

      - name: Build mediasoup-rust-server (Intel)
        run: cargo build --release --target x86_64-apple-darwin
        working-directory: mediasoup-rust-server

      - name: Build mediasoup-rust-server (ARM)
        run: cargo build --release --target aarch64-apple-darwin
        working-directory: mediasoup-rust-server

      - name: Create universal binary for mediasoup-rust-server
        run: |
          mkdir -p src-tauri/binaries/server
          lipo -create \
            mediasoup-rust-server/target/x86_64-apple-darwin/release/mediasoup-rust-server \
            mediasoup-rust-server/target/aarch64-apple-darwin/release/mediasoup-rust-server \
            -output src-tauri/binaries/server/mediasoup-rust-server
          chmod +x src-tauri/binaries/server/mediasoup-rust-server

      - name: Build frontend
        run: npm run build

      - name: Build Tauri Teacher App (Universal)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name || github.event.inputs.version }}
          releaseName: 'SmartlabPromax ${{ github.ref_name || github.event.inputs.version }}'
          releaseDraft: false
          prerelease: false
          args: --target universal-apple-darwin --bundles dmg

  build-macos-student:
    name: Build macOS Student
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri Student App (Universal)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name || github.event.inputs.version }}
          releaseName: 'SmartlabPromax ${{ github.ref_name || github.event.inputs.version }}'
          releaseDraft: false
          prerelease: false
          args: --config src-tauri/tauri.student.conf.json --target universal-apple-darwin --bundles dmg

